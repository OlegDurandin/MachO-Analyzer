# Анализ Mach-O файлов (MacOS X). 
### Финальный проект по курсе Reverse Engineering 
### Автор: Олег Дурандин (oleg.durandin@gmail.com)

## Постановка задачи
Разработать анализатор Mach-O файлов, с акцентом на Reverse-Engineer'ов и вирусных аналитиков.


Основные функции:
1) Базовый анализ заголовков
2) Просмотр секций и сегментов
3) Анализ импортов/экспортов
4) Детектирование встроенных данных
5) Поиск известных паттернов (например, anti-debugging техник, канареек и т.д.)
6) Проверка механизмов безопасности NX / DEP , ASLR, CFI (эвристика - выяснили, что неактуально для MacOS), safe stack, reloc entiries
7) Проверка осталась ли отладочная информация

## Структура проекта и общее описание

Проект имеет следующую структуру:

```tree
MachO-Analyzer/
├── src/                    # Исходный код проекта
│   ├── core/              # Основные компоненты анализатора
│   │   ├── __init__.py
│   │   ├── header_analyzer.py    # Анализ заголовков Mach-O
│   │   ├── security_analyzer.py  # Анализ механизмов безопасности
│   │   ├── symbol_analyzer.py    # Анализ символов и импортов
│   │   ├── sign_analyzer.py      # Анализ подписей кода
│   │   ├── debug_analyzer.py     # Анализ отладочной информации
│   │   └── constants.py          # Константы и определения
│   ├── utils/             # Вспомогательные утилиты
│   │   ├── __init__.py
│   │   └── helpers.py     # Общие функции-помощники
│   └── main.py            # Точка входа в программу
├── target_files/          # Тестовые файлы для анализа
│   └── test_app_with_fstack  # Тестовое приложение
├── tests/                 # Тесты
│   ├── __init__.py
│   └── test_security_analyzer.py
├── requirements.txt       # Зависимости проекта
└── README.md             # Документация проекта
```

## Основные компоненты

### 1. Core (src/core/)
- **header_analyzer.py**: Анализирует заголовки Mach-O файлов, включая:
  - Тип CPU
  - Флаги файла
  - Сегменты и секции
  - Версии и идентификаторы

- **security_analyzer.py**: Проверяет механизмы безопасности:
  - ASLR (Address Space Layout Randomization)
  - NX (Non-Executable Stack)
  - Stack Canary
  - RELRO (RELocation Read-Only)
  - Safe Stack
  - FORTIFY_SOURCE
  - Подпись кода
  - Анти-отладочные техники

- **symbol_analyzer.py**: Анализирует символы и импорты:
  - Глобальные символы
  - Динамические библиотеки
  - Импортируемые функции
  - Экспортируемые символы

- **sign_analyzer.py**: Проверяет подписи кода:
  - Статус подписи
  - Тип подписи
  - Team ID
  - Timestamp

- **debug_analyzer.py**: Анализирует отладочную информацию:
  - DWARF информация
  - Отладочные символы
  - UUID dSYM

### 2. Utils (src/utils/)
- **helpers.py**: Содержит вспомогательные функции для:
  - Работы с файлами
  - Форматирования вывода
  - Обработки ошибок

### 3. Main (src/main.py)
- Точка входа в программу
- Обработка аргументов командной строки
- Координация работы анализаторов
- Форматирование результатов

## Технические детали

### Используемые библиотеки
- `macholib`: Основная библиотека для работы с Mach-O форматом
- `dataclasses`: Для создания классов данных
- `enum`: Для определения перечислений
- `typing`: Для аннотаций типов

### Формат вывода
Результаты анализа выводятся в структурированном виде с использованием таблиц и секций:
- Основная информация о файле
- Версии и идентификаторы
- Флаги
- Сводка по сегментам
- Анализ безопасности
- Анализ символов и библиотек
- Информация о подписи
- Анализ отладочной информации

## Тестирование
Проект включает модульные тесты для проверки:
- Корректности анализа заголовков
- Работы механизмов безопасности
- Обработки различных типов файлов
- Форматирования вывода

## Документация
- README.md содержит общее описание проекта
- Комментарии в коде объясняют сложные алгоритмы

## Требования к системе
- Python 3.6+
- macOS (для работы с Mach-O файлами)
- Установленные зависимости из requirements.txt


В ходе дальнейшего изложения будут описаны ключевые пункты, касающиеся Mach-O файлов, их анализу в представленном анализаторе и вспомогательная информация, необходимая для понимания.

# Mach-O файлы
Mach-O (Mach Object) - это формат исполняемых файлов, используемый в ОС macOS и iOS. Этот формат был разработан для поддержки различных архитектур процессоров (x86_64, ARM64) и предоставляет гибкую структуру для хранения исполняемого кода, данных и метаданных.

## Структура Mach-O файла

Mach-O файл состоит из следующих основных компонентов:
1. Заголовок (Header)
* Содержит основную информацию о файле
* Определяет архитектуру и тип файла
* Указывает на расположение команд загрузки
2. Команды загрузки (Load Commands)
* Описывают как и где загружать различные части файла
* Определяют права доступа к сегментам
* Указывают на зависимости и символы
3. Данные (Data)
* Содержит исполняемый код
* Хранит данные программы
* Включает таблицы символов и строк

## Заголовок Mach-O файла
Заголовок Mach-O файла (Mach header) является первой структурой в файле и содержит основную информацию о формате и содержимом файла. Существует два варианта заголовка:

### Mach Header (32-bit)
Структура заголовка для 32-битных файлов содержит следующие поля:

```c
struct mach_header {
   uint32_t magic;
   cpu_type_t cputype;
   cpu_subtype_t cpusubtype;
   uint32_t filetype;
   uint32_t ncmds;
   uint32_t sizeofcmds;
   uint32_t flags;
};
```

- ``magic`` (uint32_t): Магическое число, идентифицирующее файл как Mach-O (``0xFEEDFACE``)
- ``cputype`` (cpu_type_t): Тип процессора (например, x86, ARM)
- ``cpusubtype`` (cpu_subtype_t): Подтип процессора
- ``filetype`` (uint32_t): Тип файла (исполняемый, библиотека и т.д.)
- ``ncmds`` (uint32_t): Количество команд загрузки
- ``sizeofcmds`` (uint32_t): Общий размер всех команд загрузки
- ``flags`` (uint32_t): Флаги, определяющие различные характеристики файла

### Mach Header 64 (64-bit)
Для 64-битных файлов структура расширена и включает дополнительное поле:


```c
struct mach_header_64 {
   uint32_t magic;
   cpu_type_t cputype;
   cpu_subtype_t cpusubtype;
   uint32_t filetype;
   uint32_t ncmds;
   uint32_t sizeofcmds;
   uint32_t flags;
   uint32_t reserved;
};
```

- ``magic`` (uint32_t): Магическое число для 64-bit (0xFEEDFACF)
- ``cputype`` (cpu_type_t): Тип процессора
- ``cpusubtype`` (cpu_subtype_t): Подтип процессора  
- ``filetype`` (uint32_t): Тип файла
- ``ncmds`` (uint32_t): Количество команд загрузки
- ``sizeofcmds`` (uint32_t): Общий размер команд
- ``flags`` (uint32_t): Флаги файла
- ``reserved`` (uint32_t): Зарезервированное поле (добавлено для 64-bit)


Link: https://github.com/aidansteele/osx-abi-macho-file-format-reference 

### Основные значения полей

#### Magic Numbers
- ``0xFEEDFACE`` - 32-битный Mach-O
- ``0xFEEDFACF`` - 64-битный Mach-O
- ``0xCAFEBABE`` - Universal binary

#### CPU Types
- ``CPU_TYPE_X86 (7)``
- ``CPU_TYPE_X86_64 (7 | CPU_ARCH_ABI64)``
- ``CPU_TYPE_ARM (12)``
- ``CPU_TYPE_ARM64 (12 | CPU_ARCH_ABI64)``

#### File Types
- ``MH_OBJECT (0x1)``: Объектный файл
- ``MH_EXECUTE (0x2)``: Исполняемый файл
- ``MH_DYLIB (0x6)``: Динамическая библиотека
- ``MH_BUNDLE (0x8)``: Bundle
- ``MH_DYLINKER (0x7)``: Динамический линковщик
- ``MH_DSYM (0xa)``: Отладочные символы

#### Flags
- ``MH_NOUNDEFS``: Нет неопределённых ссылок
- ``MH_DYLDLINK``: Объект является динамически связываемым
- ``MH_PIE``: Position Independent Executable
- ``MH_TWOLEVEL``: Двухуровневое пространство имён
- ``MH_WEAK_DEFINES``: Файл содержит слабо определённые символы
- ``MH_ALLOW_STACK_EXECUTION``: Разрешено исполнение стека

### Реализация анализа заголовка 

#### Класс HeaderAnalyzer


```python
class HeaderAnalyzer:
    def analyze(self, header: MachOHeader) -> Dict[str, Any]:
        """
        Анализирует заголовок Mach-O файла и возвращает структурированную информацию
        """
        result = {
            "magic": self._get_magic(header),
            "cpu_type": self._get_cpu_type(header),
            "file_type": self._get_file_type(header),
            "flags": self._get_flags(header),
            "commands": self._get_commands_info(header)
        }
        return result
```

Результаты анализа выводятся в структурированном виде:

Основная информация        
┏━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┓
┃ Параметр          ┃ Значение    ┃
┡━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━┩
│ Magic             │ MH_CIGAM_64 │
│ Битность          │ 64-bit      │
│ CPU Type          │ arm64       │
│ CPU Subtype       │ 0           │
│ Тип файла         │ Executable  │
│ Количество команд │ 17          │
│ Размер команд     │ 1056 байт   │
└───────────────────┴─────────────┘

Флаги                        
┏━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Флаг        ┃ Описание                            ┃
┡━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ MH_NOUNDEFS │ Не содержит неопределенных символов │
│ MH_DYLDLINK │ Динамически связанный               │
│ MH_TWOLEVEL │ Двухуровневое пространство имен     │
│ MH_PIE      │ Position Independent Executable     │
└─────────────┴─────────────────────────────────────┘

### Особенности реализации:
1. Обработка ошибок:
* Проверка корректности магического числа
* Валидация типа CPU
* Обработка неизвестных флагов
2. Оптимизация:
* Кэширование результатов анализа
* Эффективное использование памяти
* Быстрый доступ к часто используемым значениям
3. Расширяемость:
* Легкое добавление новых флагов
* Поддержка новых типов CPU
* Возможность добавления дополнительных проверок

Этот анализ позволяет получить полную картину структуры Mach-O файла и его характеристик безопасности, что является важным этапом в процессе анализа безопасности приложения.